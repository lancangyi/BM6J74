C51 COMPILER V7.50   OEM_FAN                                                               09/25/2020 15:06:33 PAGE 1   


C51 COMPILER V7.50, COMPILATION OF MODULE OEM_FAN
OBJECT MODULE PLACED IN Oem\Oem_Fan.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\c51.exe Oem\Oem_Fan.c LA WL(1) CD OT(9,SIZE) NOAREGS OR INCDIR(.\Core\Include\;.\Oe
                    -m\Include\)

line level    source

   1          /*-----------------------------------------------------------------------------
   2           * Filename: OEM_FAN.C
   3           * Function: OEM FAN Control
   4           *
   5           * Copyright (c) 2009-2012, ITE Tech. Inc. All Rights Reserved.
   6           *---------------------------------------------------------------------------*/
   7           
   8          #include "CORE_INC.H"
   9          #include "OEM_INC.H"
  10          
  11          ECReg   ADC_TEMP_ENABLE                 _at_ (GEE_BASE_ADDR + 0x51);
  12          ECReg   ADC_TEMP_EXTRA_ENABLE   _at_ (GEE_BASE_ADDR + 0x55);
  13          
  14          ECReg   FAN1_TEMP_OFF                   _at_ (GEE_BASE_ADDR + 0x60);
  15          ECReg   FAN1_TEMP_START                 _at_ (GEE_BASE_ADDR + 0x61);
  16          ECReg   FAN1_TEMP_FULL                  _at_ (GEE_BASE_ADDR + 0x62);
  17          ECReg   FAN1_CTRL                               _at_ (GEE_BASE_ADDR + 0x64);
  18          ECReg   FAN1_TEMP_DELTA                 _at_ (GEE_BASE_ADDR + 0x65);
  19          ECReg   FAN1_ZONE                               _at_ (GEE_BASE_ADDR + 0x66);
  20          
  21          ECReg   FAN2_TEMP_OFF                   _at_ (GEE_BASE_ADDR + 0x68);
  22          ECReg   FAN2_TEMP_START                 _at_ (GEE_BASE_ADDR + 0x69);
  23          ECReg   FAN2_TEMP_FULL                  _at_ (GEE_BASE_ADDR + 0x6A);
  24          ECReg   FAN2_CTRL                               _at_ (GEE_BASE_ADDR + 0x6C);
  25          ECReg   FAN2_TEMP_DELTA                 _at_ (GEE_BASE_ADDR + 0x6D);
  26          ECReg   FAN2_ZONE                               _at_ (GEE_BASE_ADDR + 0x6E);
  27          
  28          ECReg   FAN3_TEMP_OFF                   _at_ (GEE_BASE_ADDR + 0x70);
  29          ECReg   FAN3_TEMP_START                 _at_ (GEE_BASE_ADDR + 0x71);
  30          ECReg   FAN3_TEMP_FULL                  _at_ (GEE_BASE_ADDR + 0x72);
  31          ECReg   FAN3_CTRL                               _at_ (GEE_BASE_ADDR + 0x74);
  32          ECReg   FAN3_TEMP_DELTA                 _at_ (GEE_BASE_ADDR + 0x75);
  33          ECReg   FAN3_ZONE                               _at_ (GEE_BASE_ADDR + 0x76);
  34          
  35          ECReg   FAN_A_TEMP_START                _at_ (GEE_BASE_ADDR + 0x90);
  36          ECReg   FAN_A_SLOP                              _at_ (GEE_BASE_ADDR + 0x91);
  37          ECReg   FAN_A_TEMP_DELTA                _at_ (GEE_BASE_ADDR + 0x92);
  38          
  39          ECReg   FAN_B_TEMP_START                _at_ (GEE_BASE_ADDR + 0x94);
  40          ECReg   FAN_B_SLOP                              _at_ (GEE_BASE_ADDR + 0x95);
  41          ECReg   FAN_B_TEMP_DELTA                _at_ (GEE_BASE_ADDR + 0x96);
  42          //-----------------------------------------------------------------------------
  43          /*****************************************************************************/
  44          /* PWM/TACHX MODULE **********************************************************/
  45          /*****************************************************************************/
  46          //-----------------------------------------------------------------------------
  47          // Calculation Fan Tachometer to Fan Speed (R.P.M)
  48          // Fan Speed (R.P.M)=60/(1/fs sec * {FnTMRR,FnTLRR) * P )
  49          //-----------------------------------------------------------------------------
  50          WORD GetFanRPM(BYTE FnTMRR,BYTE FnTLRR)
  51          {
  52   1              WORD    FanRPMSpd, FanRPMDiv;
  53   1              WORD    FnTWRR; 
  54   1      
C51 COMPILER V7.50   OEM_FAN                                                               09/25/2020 15:06:33 PAGE 2   

  55   1              if( (FnTMRR == 0xFF)&&(FnTLRR == 0xFF) )
  56   1                      return 0;
  57   1      
  58   1      
  59   1              FnTWRR = FnTMRR*0x100+FnTLRR;
  60   1              
  61   1      
  62   1              FanRPMSpd = 675000 / FnTWRR;
  63   1      
  64   1              return FanRPMSpd;
  65   1      
  66   1      }
  67          
  68          void EC_start(void)
  69          {
  70   1              CFG_REG |= 0x80;                                // Restore EC registers to their default values
  71   1              CFG_REG &= 0xFE;                                // Put EC in standby mode
  72   1      
  73   1              PWM_STEP_FREQ_REG = 0x8F;               // FAN smoothing step freq: 8Hz, FAN4: none
  74   1              FAN_MAIN_CTL = 0x33;                    // Enable TACH2/TACH1, enable FAN2/FAN1 smartguardian mode
  75   1              FAN_CTL = 0xC0;                                 // FAN Active Polarity: High, PWM freq for FAN1/FAN3: 23.43KHz
  76   1              ADC_TEMP_EXTRA_ENABLE = 0x40;   // PWM freq for FAN2: 23.43KHz
  77   1      
  78   1              FAN_CTL1 = 0x85;                                // FAN1: auto mode, tacho close-loop mode, temperature: TMPIN2 CPU
  79   1              FAN1_TEMP_OFF = 0;
  80   1              FAN1_TEMP_START = 50;                   // First phase: 50°C - 60°C
  81   1              FAN1_TEMP_FULL = 80;                    // Full speed temperature: 80°C
  82   1              PWM_FAN_CTL1 = 185;                     // Start RPM: 125 * 16 = 2000 RPM
  83   1              FAN1_CTRL = 0x80 + 5;                   // Smoothing mode, Slop = 400RPM / 10°C = 40RPM/°C(40 / 8 = 5)
  84   1              FAN1_TEMP_DELTA = 2;                    // Delta-temperature: 2°C
  85   1              FAN1_ZONE = 16;                                 // Target Zone: 128 RPM = 16 * 8
  86   1              FAN_A_TEMP_START = 60;                  // Second phase: 60°C - 70°C
  87   1              FAN_A_SLOP = 0x80+8;                            // (FAN_B_TEMP_DELTA.1, FAN_B_SLOP.7)=01: TMPIN2, SLOP = 600 RPM / 10°C = 60 RPM
             -/°C(60 / 8 = 7.5)
  88   1              FAN_A_TEMP_DELTA = 0x22;                // Extra-A for FAN1, Delta-temperature: 2°C
  89   1      /*
  90   1              FAN_CTL2 = 0x84;                                // FAN2: auto mode, tacho close-loop mode, temperature: TMPIN1 SYS
  91   1              FAN2_TEMP_OFF = 0;
  92   1              FAN2_TEMP_START = 50;                   // First phase: 50°C - 60°C
  93   1              FAN2_TEMP_FULL = 80;                    // Full speed temperature: 80°C
  94   1              PWM_FAN_CTL2 = 125;                     // Start RPM: 125 * 16 = 2000 RPM
  95   1              FAN2_CTRL = 0x80 + 15;                  // Smoothing mode, Slop = 1200 RPM / 10°C = 120 RPM/°C(120 / 8 = 15)
  96   1              FAN2_TEMP_DELTA = 2;                    // Delta-temperature: 2°C
  97   1              FAN2_ZONE = 15;                                 // Target Zone: 128 RPM = 16 * 8
  98   1              FAN_B_TEMP_START = 60;                  // Second phase: 60°C - 70°C
  99   1              FAN_B_SLOP = 0x80 + 16;                 // (FAN_B_TEMP_DELTA.1, FAN_B_SLOP.7)=01: TMPIN1, SLOP = 1300 RPM / 10°C = 130
             - RPM/°C(130 / 8 = 16.25)
 100   1              FAN_B_TEMP_DELTA = 0x22;                // Extra-B for FAN2, Delta-temperature: 2°C
 101   1      */
 102   1              ADC_TEMP_ENABLE = 0x03;                 // TMPIN2/TMPIN1 enable thermal diode mode
 103   1              ADC_channel_enable = 0xFF;                      // enable voltage A/D conversion for VIN0-VIN7
 104   1      
 105   1              CFG_REG |= 0x01;                                // Start EC
 106   1      }
 107          
 108          void EC_stop(void)
 109          {
 110   1              CFG_REG |= 0x80;                                // Restore EC registers to their default values
 111   1              CFG_REG &= 0xFE;                                // Put EC in standby mode
 112   1      }
C51 COMPILER V7.50   OEM_FAN                                                               09/25/2020 15:06:33 PAGE 3   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION Com0005 (BEGIN)
0000         L?0006:
0000 900000      E     MOV     DPTR,#CFG_REG
0003 E0                MOVX    A,@DPTR
0004 4480              ORL     A,#080H
0006 F0                MOVX    @DPTR,A
0007 E0                MOVX    A,@DPTR
0008 54FE              ANL     A,#0FEH
000A F0                MOVX    @DPTR,A
000B 22                RET     
             ; FUNCTION Com0005 (END)

             ; FUNCTION _GetFanRPM (BEGIN)
                                           ; SOURCE LINE # 50
;---- Variable 'FnTLRR' assigned to Register 'R5' ----
;---- Variable 'FnTMRR' assigned to Register 'R7' ----
                                           ; SOURCE LINE # 51
                                           ; SOURCE LINE # 55
0000 EF                MOV     A,R7
0001 B4FF08            CJNE    A,#0FFH,?C0001
0004 ED                MOV     A,R5
0005 B4FF04            CJNE    A,#0FFH,?C0001
                                           ; SOURCE LINE # 56
0008 E4                CLR     A
0009 FE                MOV     R6,A
000A FF                MOV     R7,A
000B 22                RET     
000C         ?C0001:
                                           ; SOURCE LINE # 59
000C EF                MOV     A,R7
000D FE                MOV     R6,A
000E 7C00              MOV     R4,#00H
0010 E4                CLR     A
0011 2D                ADD     A,R5
0012 FF                MOV     R7,A
0013 EC                MOV     A,R4
0014 3E                ADDC    A,R6
0015 900000      R     MOV     DPTR,#FnTWRR
0018 F0                MOVX    @DPTR,A
0019 A3                INC     DPTR
001A EF                MOV     A,R7
001B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 62
001C 900000      R     MOV     DPTR,#FnTWRR
001F E0                MOVX    A,@DPTR
0020 FE                MOV     R6,A
0021 A3                INC     DPTR
0022 E0                MOVX    A,@DPTR
0023 FB                MOV     R3,A
0024 CA                XCH     A,R2
0025 EE                MOV     A,R6
0026 CA                XCH     A,R2
0027 E4                CLR     A
0028 F9                MOV     R1,A
0029 F8                MOV     R0,A
002A 7FB8              MOV     R7,#0B8H
002C 7E4C              MOV     R6,#04CH
002E 7D0A              MOV     R5,#0AH
0030 120000      E     LCALL   ?C?SLDIV
C51 COMPILER V7.50   OEM_FAN                                                               09/25/2020 15:06:33 PAGE 4   

0033 900000      R     MOV     DPTR,#FanRPMSpd
0036 EE                MOV     A,R6
0037 F0                MOVX    @DPTR,A
0038 A3                INC     DPTR
0039 EF                MOV     A,R7
003A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 64
003B 900000      R     MOV     DPTR,#FanRPMSpd
003E E0                MOVX    A,@DPTR
003F FE                MOV     R6,A
0040 A3                INC     DPTR
0041 E0                MOVX    A,@DPTR
0042 FF                MOV     R7,A
                                           ; SOURCE LINE # 66
0043         ?C0002:
0043 22                RET     
             ; FUNCTION _GetFanRPM (END)

             ; FUNCTION EC_start (BEGIN)
                                           ; SOURCE LINE # 68
                                           ; SOURCE LINE # 69
                                           ; SOURCE LINE # 70
                                           ; SOURCE LINE # 71
0000 120000      R     LCALL   L?0006
                                           ; SOURCE LINE # 73
0003 900000      E     MOV     DPTR,#PWM_STEP_FREQ_REG
0006 748F              MOV     A,#08FH
0008 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 74
0009 900000      E     MOV     DPTR,#FAN_MAIN_CTL
000C 7433              MOV     A,#033H
000E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 75
000F 900000      E     MOV     DPTR,#FAN_CTL
0012 74C0              MOV     A,#0C0H
0014 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 76
0015 902A55            MOV     DPTR,#ADC_TEMP_EXTRA_ENABLE
0018 7440              MOV     A,#040H
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 78
001B 900000      E     MOV     DPTR,#FAN_CTL1
001E 7485              MOV     A,#085H
0020 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 79
0021 E4                CLR     A
0022 902A60            MOV     DPTR,#FAN1_TEMP_OFF
0025 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 80
0026 A3                INC     DPTR
0027 7432              MOV     A,#032H
0029 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 81
002A A3                INC     DPTR
002B 7450              MOV     A,#050H
002D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 82
002E 900000      E     MOV     DPTR,#PWM_FAN_CTL1
0031 74B9              MOV     A,#0B9H
0033 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 83
0034 902A64            MOV     DPTR,#FAN1_CTRL
C51 COMPILER V7.50   OEM_FAN                                                               09/25/2020 15:06:33 PAGE 5   

0037 7485              MOV     A,#085H
0039 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 84
003A A3                INC     DPTR
003B 7402              MOV     A,#02H
003D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 85
003E A3                INC     DPTR
003F 7410              MOV     A,#010H
0041 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 86
0042 902A90            MOV     DPTR,#FAN_A_TEMP_START
0045 743C              MOV     A,#03CH
0047 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 87
0048 A3                INC     DPTR
0049 7488              MOV     A,#088H
004B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 88
004C A3                INC     DPTR
004D 7422              MOV     A,#022H
004F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 102
0050 902A51            MOV     DPTR,#ADC_TEMP_ENABLE
0053 7403              MOV     A,#03H
0055 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 103
0056 900000      E     MOV     DPTR,#ADC_channel_enable
0059 74FF              MOV     A,#0FFH
005B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 105
005C 900000      E     MOV     DPTR,#CFG_REG
005F E0                MOVX    A,@DPTR
0060 4401              ORL     A,#01H
0062 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 106
0063 22                RET     
             ; FUNCTION EC_start (END)

             ; FUNCTION EC_stop (BEGIN)
                                           ; SOURCE LINE # 108
                                           ; SOURCE LINE # 109
                                           ; SOURCE LINE # 110
                                           ; SOURCE LINE # 111
0000 120000      R     LCALL   L?0006
                                           ; SOURCE LINE # 112
0003 22                RET     
             ; FUNCTION EC_stop (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    184    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       6
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
